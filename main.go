package main

import (
	"log"
	"os"
	"time"

	"github.com/PavelVershinin/docker_systray_menu/pkg/docker"

	"github.com/getlantern/systray"
)

var (
	icon            = []byte{137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 64, 0, 0, 0, 64, 8, 6, 0, 0, 0, 170, 105, 113, 222, 0, 0, 0, 6, 98, 75, 71, 68, 0, 255, 0, 255, 0, 255, 160, 189, 167, 147, 0, 0, 3, 106, 73, 68, 65, 84, 120, 156, 237, 154, 239, 107, 142, 81, 24, 199, 63, 179, 31, 50, 211, 60, 181, 153, 182, 169, 53, 82, 178, 252, 72, 136, 253, 32, 111, 88, 254, 1, 94, 136, 119, 94, 73, 18, 69, 145, 23, 94, 48, 74, 121, 33, 81, 72, 145, 68, 137, 90, 169, 149, 36, 35, 191, 106, 182, 178, 8, 53, 20, 35, 68, 179, 213, 236, 121, 188, 56, 77, 247, 115, 221, 207, 253, 235, 185, 207, 253, 67, 206, 167, 206, 139, 61, 215, 57, 215, 245, 189, 174, 157, 251, 60, 231, 156, 251, 1, 131, 193, 96, 48, 24, 12, 255, 43, 37, 26, 124, 228, 2, 198, 8, 218, 63, 82, 166, 196, 25, 44, 141, 152, 2, 36, 45, 32, 105, 76, 1, 146, 22, 144, 52, 166, 0, 73, 11, 48, 24, 12, 197, 82, 14, 212, 38, 45, 34, 41, 154, 128, 135, 192, 61, 160, 84, 183, 243, 156, 71, 139, 187, 191, 164, 3, 248, 98, 233, 191, 215, 95, 90, 254, 73, 115, 1, 90, 129, 159, 162, 255, 15, 160, 206, 111, 114, 126, 72, 107, 1, 150, 99, 79, 126, 178, 157, 12, 144, 159, 39, 105, 44, 64, 13, 240, 206, 101, 204, 8, 144, 9, 148, 165, 11, 105, 44, 192, 185, 2, 253, 178, 226, 239, 93, 129, 178, 116, 33, 109, 5, 88, 136, 61, 217, 83, 192, 85, 241, 89, 127, 208, 68, 157, 72, 91, 1, 142, 11, 251, 107, 160, 10, 104, 6, 198, 132, 173, 57, 96, 174, 5, 73, 91, 1, 158, 9, 251, 22, 139, 237, 180, 176, 109, 245, 157, 229, 63, 196, 55, 242, 147, 172, 177, 216, 218, 133, 237, 57, 208, 5, 108, 3, 230, 198, 170, 50, 66, 228, 52, 159, 106, 177, 101, 112, 159, 77, 143, 129, 157, 104, 252, 134, 72, 130, 207, 228, 39, 53, 75, 216, 189, 30, 169, 28, 240, 29, 56, 8, 76, 139, 71, 178, 94, 30, 144, 159, 204, 60, 97, 183, 218, 228, 108, 145, 237, 41, 208, 224, 22, 172, 218, 195, 65, 26, 218, 106, 161, 185, 133, 252, 41, 222, 128, 90, 40, 239, 58, 140, 95, 229, 86, 128, 138, 20, 36, 232, 213, 118, 187, 37, 96, 97, 51, 48, 33, 198, 222, 244, 51, 208, 105, 191, 157, 150, 214, 235, 161, 191, 12, 56, 4, 140, 139, 113, 67, 192, 108, 63, 5, 24, 76, 65, 146, 110, 45, 11, 204, 177, 232, 173, 64, 157, 6, 215, 0, 199, 40, 124, 102, 248, 132, 122, 84, 124, 209, 35, 6, 31, 240, 59, 48, 102, 246, 227, 175, 96, 131, 192, 130, 32, 142, 47, 8, 7, 87, 116, 41, 214, 72, 6, 248, 138, 123, 226, 19, 192, 89, 96, 70, 80, 231, 187, 132, 163, 151, 90, 36, 235, 165, 11, 231, 196, 71, 81, 255, 180, 37, 197, 58, 95, 92, 192, 105, 83, 40, 185, 122, 105, 4, 126, 145, 175, 175, 7, 56, 2, 108, 2, 102, 134, 13, 80, 2, 12, 139, 0, 59, 66, 248, 219, 8, 188, 71, 45, 78, 157, 97, 197, 1, 231, 201, 215, 214, 75, 4, 191, 41, 184, 44, 130, 60, 9, 225, 203, 186, 42, 15, 133, 212, 213, 138, 253, 110, 160, 35, 164, 207, 130, 172, 197, 254, 24, 172, 44, 210, 151, 174, 2, 148, 1, 125, 66, 211, 173, 16, 254, 60, 233, 23, 193, 186, 139, 244, 211, 137, 42, 194, 16, 176, 33, 132, 158, 125, 66, 207, 24, 48, 63, 132, 63, 79, 182, 99, 159, 5, 126, 90, 20, 180, 99, 223, 217, 29, 142, 40, 214, 95, 202, 129, 1, 146, 47, 64, 29, 240, 65, 196, 120, 3, 84, 70, 16, 203, 70, 27, 246, 69, 39, 206, 2, 212, 162, 110, 121, 172, 254, 199, 81, 51, 34, 54, 46, 145, 76, 1, 234, 40, 60, 3, 247, 104, 140, 225, 139, 74, 212, 213, 146, 20, 114, 17, 152, 30, 81, 204, 118, 212, 162, 41, 99, 222, 32, 230, 223, 17, 78, 82, 239, 32, 104, 128, 16, 91, 78, 135, 56, 103, 176, 159, 227, 115, 168, 11, 142, 68, 175, 180, 154, 81, 139, 143, 20, 150, 5, 174, 161, 182, 208, 197, 80, 10, 172, 67, 29, 194, 156, 174, 180, 186, 137, 104, 182, 5, 157, 78, 141, 192, 117, 96, 133, 131, 253, 5, 112, 27, 184, 3, 188, 69, 93, 104, 14, 163, 190, 81, 42, 81, 39, 179, 122, 212, 121, 190, 5, 88, 138, 218, 201, 85, 59, 248, 203, 2, 71, 81, 23, 154, 191, 3, 106, 141, 140, 10, 224, 4, 133, 167, 169, 206, 214, 71, 204, 171, 125, 80, 150, 1, 247, 209, 159, 248, 0, 234, 13, 79, 89, 124, 169, 132, 163, 3, 181, 6, 140, 82, 124, 210, 67, 168, 215, 92, 109, 196, 188, 202, 235, 12, 86, 5, 172, 71, 93, 91, 47, 66, 189, 154, 202, 160, 206, 231, 99, 168, 2, 141, 160, 118, 117, 31, 81, 87, 85, 253, 192, 35, 224, 149, 70, 29, 6, 131, 193, 96, 48, 24, 12, 190, 248, 3, 207, 96, 14, 150, 46, 16, 177, 190, 0, 0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130}
	dockerCmd       = &docker.Docker{}
	dockerItem      *systray.MenuItem
	containersItems = make(map[string]*systray.MenuItem)
	exitItem        *systray.MenuItem
)

func main() {
	systray.Run(onReady, onExit)
}

func onReady() {
	systray.SetIcon(icon)
	systray.SetTitle("Docker containers")
	systray.SetTooltip("Docker containers")

	dockerItem = systray.AddMenuItem("Docker", "")

	systray.AddSeparator()

	updateMenu()

	systray.AddSeparator()
	exitItem = systray.AddMenuItem("Exit", "")

	go func() {
		for {
			select {
			case <-dockerItem.ClickedCh:
				if err := dockerCmd.Toggle(); err != nil {
					log.Println(err)
				}
			case <-exitItem.ClickedCh:
				os.Exit(0)
			}
		}
	}()

	go func() {
		for {
			<-time.After(time.Millisecond * 500)
			updateMenu()
		}
	}()
}

func onExit() {

}

func updateMenu() {
	if !dockerCmd.IsRunning() {
		dockerItem.SetTitle("Start docker")
		for _, item := range containersItems {
			item.Disable()
		}
		return
	}

	dockerItem.SetTitle("Stop docker")

	containers, err := dockerCmd.Containers(true)
	if err != nil {
		log.Println(err)
		return
	}

	for _, container := range containers {
		if _, ok := containersItems[container.ID]; !ok {
			containersItems[container.ID] = systray.AddMenuItem("", "")
			go func(containerID string) {
				for range containersItems[containerID].ClickedCh {
					if err := dockerCmd.ToggleContainer(containerID); err != nil {
						log.Println(err)
					}
				}
			}(container.ID)
		} else if containersItems[container.ID].Disabled() {
			containersItems[container.ID].Enable()
		}

		if container.Running {
			containersItems[container.ID].SetTitle("Stop " + container.Names)
		} else {
			containersItems[container.ID].SetTitle("Start " + container.Names)
		}
	}
}
